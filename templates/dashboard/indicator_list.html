{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-undp-text">{{ title }}</h1>
            <p class="text-undp-text-light mt-2">
                {% if user.profile.is_admin %}
                    All active indicators in the system
                {% else %}
                    Indicators for your assigned projects
                {% endif %}
            </p>
        </div>
        
        <div class="flex space-x-4">
            {% if user.profile.is_admin %}
                <a href="{% url 'dashboard:indicator_create' %}" class="btn-primary">
                    <i class="fas fa-plus mr-2"></i>Add Indicator
                </a>
            {% endif %}
            <a href="{% url 'dashboard:project_list' %}" class="btn-secondary">
                <i class="fas fa-project-diagram mr-2"></i>View Projects
            </a>
        </div>
    </div>


    <!-- Indicators Table -->
    <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
        <div class="bg-gradient-to-r from-undp-blue to-blue-600 px-6 py-4">
            <div class="flex justify-between items-center">
                <div>
                    <h3 class="text-xl font-bold text-white">Indicators Overview</h3>
                    <p class="text-blue-100 mt-1">{{ indicators.count }} indicator{{ indicators.count|pluralize }} available</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="table-view" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition-all duration-200 active">
                        <i class="fas fa-table mr-2"></i>Table View
                    </button>
                    <button id="card-view" class="bg-white bg-opacity-10 text-white px-4 py-2 rounded-lg hover:bg-opacity-20 transition-all duration-200">
                        <i class="fas fa-th-large mr-2"></i>Card View
                    </button>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto" id="table-container">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-chart-line text-undp-blue"></i>
                                <span>Indicator Details</span>
                            </div>
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-tag text-undp-blue"></i>
                                <span>Type & Unit</span>
                            </div>
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-bullseye text-undp-blue"></i>
                                <span>Target & Frequency</span>
                            </div>
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-users text-undp-blue"></i>
                                <span>Projects & Team</span>
                            </div>
                        </th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700 uppercase tracking-wider">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-info-circle text-undp-blue"></i>
                                <span>Status</span>
                            </div>
                        </th>
                        <th class="px-6 py-4 text-center text-sm font-semibold text-gray-700 uppercase tracking-wider">
                            <div class="flex items-center justify-center space-x-2">
                                <i class="fas fa-cog text-undp-blue"></i>
                                <span>Actions</span>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for indicator in indicators %}
                        <tr class="hover:bg-blue-50 transition-all duration-200 group">
                            <td class="px-6 py-6">
                                <div class="flex items-start space-x-4">
                                    <div class="flex-shrink-0">
                                        <div class="w-12 h-12 bg-gradient-to-br from-undp-blue to-blue-600 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-chart-bar text-white text-lg"></i>
                                        </div>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <h4 class="text-lg font-semibold text-gray-900 group-hover:text-undp-blue transition-colors duration-200">
                                            {{ indicator.name }}
                                        </h4>
                                        <p class="text-sm text-gray-500 font-mono">{{ indicator.code }}</p>
                                        {% if indicator.description %}
                                            <p class="text-sm text-gray-600 mt-2 line-clamp-2">
                                                {{ indicator.description|truncatewords:15 }}
                                            </p>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-6">
                                <div class="space-y-3">
                                    <div>
                                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium
                                            {% if indicator.indicator_type == 'output' %}bg-blue-100 text-blue-800 border border-blue-200
                                            {% elif indicator.indicator_type == 'outcome' %}bg-green-100 text-green-800 border border-green-200
                                            {% elif indicator.indicator_type == 'impact' %}bg-purple-100 text-purple-800 border border-purple-200
                                            {% else %}bg-gray-100 text-gray-800 border border-gray-200{% endif %}">
                                            <i class="fas fa-tag mr-2 text-xs"></i>
                                            {{ indicator.get_indicator_type_display }}
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        <i class="fas fa-ruler mr-2 text-gray-400"></i>
                                        {{ indicator.get_measurement_unit_display }}
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-6">
                                <div class="space-y-3">
                                    <div class="flex items-center space-x-2">
                                        <div class="w-2 h-2 bg-undp-blue rounded-full"></div>
                                        <span class="text-lg font-bold text-gray-900">{{ indicator.target_value }}</span>
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        <i class="fas fa-calendar-alt mr-2 text-gray-400"></i>
                                        {{ indicator.get_frequency_display }}
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-6">
                                <div class="space-y-3">
                                    <div class="flex items-center space-x-2">
                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                            <i class="fas fa-project-diagram mr-1"></i>
                                            {{ indicator.projects.count }} project{{ indicator.projects.count|pluralize }}
                                        </span>
                                    </div>
                                    {% if indicator.responsible_user %}
                                        <div class="flex items-center space-x-2">
                                            <div class="w-8 h-8 bg-gradient-to-br from-undp-blue to-blue-600 rounded-full flex items-center justify-center">
                                                <span class="text-white text-sm font-semibold">
                                                    {{ indicator.responsible_user.first_name|first|default:indicator.responsible_user.username|first|upper }}
                                                </span>
                                            </div>
                                            <div class="text-sm text-gray-600">
                                                {{ indicator.responsible_user.get_full_name|default:indicator.responsible_user.username|truncatechars:20 }}
                                            </div>
                                        </div>
                                    {% else %}
                                        <span class="text-sm text-gray-400 italic">Not assigned</span>
                                    {% endif %}
                                </div>
                            </td>
                            <td class="px-6 py-6">
                                {% if indicator.values.count > 0 %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800 border border-green-200">
                                        <i class="fas fa-check-circle mr-2"></i>
                                        Active
                                    </span>
                                {% else %}
                                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800 border border-yellow-200">
                                        <i class="fas fa-clock mr-2"></i>
                                        Pending
                                    </span>
                                {% endif %}
                            </td>
                            <td class="px-6 py-6">
                                <div class="flex items-center justify-center space-x-2">
                                    <a href="{% url 'dashboard:indicator_detail' indicator.id %}" 
                                       class="inline-flex items-center px-3 py-2 text-sm font-medium text-undp-blue bg-blue-50 rounded-lg hover:bg-blue-100 transition-all duration-200" 
                                       title="View Details">
                                        <i class="fas fa-eye mr-1"></i>
                                        View
                                    </a>
                                    
                                    {% if user.profile.is_admin %}
                                        <a href="{% url 'dashboard:indicator_edit' indicator.id %}" 
                                           class="inline-flex items-center px-3 py-2 text-sm font-medium text-yellow-700 bg-yellow-50 rounded-lg hover:bg-yellow-100 transition-all duration-200" 
                                           title="Edit Indicator">
                                            <i class="fas fa-edit mr-1"></i>
                                            Edit
                                        </a>
                                    {% endif %}
                                    
                                    {% if user.profile.is_project_user %}
                                        {% for project in indicator.projects.all %}
                                            {% if project.created_by == user %}
                                                <a href="{% url 'dashboard:data_entry_form' project.id %}" 
                                                   class="inline-flex items-center px-3 py-2 text-sm font-medium text-green-700 bg-green-50 rounded-lg hover:bg-green-100 transition-all duration-200" 
                                                   title="Submit Data">
                                                    <i class="fas fa-clipboard-list mr-1"></i>
                                                    Submit
                                                </a>
                                            {% endif %}
                                        {% empty %}
                                            <span class="text-xs text-gray-400">No access</span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="text-xs text-gray-400" title="Only project users can submit data">View Only</span>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center">
                                <div class="flex flex-col items-center space-y-4">
                                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center">
                                        <i class="fas fa-chart-bar text-2xl text-gray-400"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-semibold text-gray-900">No indicators found</h3>
                                        <p class="text-gray-500">Get started by creating your first indicator.</p>
                                    </div>
                                    {% if user.profile.is_admin %}
                                        <a href="{% url 'dashboard:indicator_create' %}" class="inline-flex items-center px-4 py-2 bg-undp-blue text-white rounded-lg hover:bg-blue-700 transition-colors duration-200">
                                            <i class="fas fa-plus mr-2"></i>
                                            Create First Indicator
                                        </a>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Card View (Hidden by default) -->
        <div id="card-container" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 p-6">
            {% for indicator in indicators %}
                <div class="bg-white border border-undp-gray-dark rounded-lg p-6 hover:shadow-lg transition-shadow duration-200">
                    <div class="flex items-start justify-between mb-4">
                        <div class="flex-1">
                            <h4 class="text-lg font-semibold text-undp-text mb-2">{{ indicator.name }}</h4>
                            <p class="text-sm text-undp-text-light mb-3">{{ indicator.code }}</p>
                            {% if indicator.description %}
                                <p class="text-xs text-undp-text-light mb-3">
                                    {{ indicator.description|truncatewords:15 }}
                                </p>
                            {% endif %}
                        </div>
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if indicator.indicator_type == 'output' %}bg-blue-100 text-blue-800
                            {% elif indicator.indicator_type == 'outcome' %}bg-green-100 text-green-800
                            {% elif indicator.indicator_type == 'impact' %}bg-purple-100 text-purple-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ indicator.get_indicator_type_display }}
                        </span>
                    </div>
                    
                    <div class="space-y-3 mb-4">
                        <div class="flex justify-between text-sm">
                            <span class="text-undp-text-light">Target:</span>
                            <span class="font-semibold text-undp-blue">{{ indicator.target_value }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-undp-text-light">Unit:</span>
                            <span class="text-undp-text">{{ indicator.get_measurement_unit_display }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-undp-text-light">Frequency:</span>
                            <span class="text-undp-text">{{ indicator.get_frequency_display }}</span>
                        </div>
                        <div class="flex justify-between text-sm">
                            <span class="text-undp-text-light">Projects:</span>
                            <span class="text-undp-text">{{ indicator.projects.count }}</span>
                        </div>
                    </div>
                    
                    <div class="border-t border-undp-gray-dark pt-4">
                        <div class="flex items-center justify-between">
                            <div class="flex space-x-2">
                                <a href="{% url 'dashboard:indicator_detail' indicator.id %}" 
                                   class="text-undp-blue hover:text-undp-blue-dark" 
                                   title="View Details">
                                    <i class="fas fa-eye"></i>
                                </a>
                                
                                {% if user.profile.is_project_user %}
                                    {% for project in indicator.projects.all %}
                                        {% if project.created_by == user %}
                                            <a href="{% url 'dashboard:data_entry_form' project.id %}" 
                                               class="text-success hover:text-green-600" 
                                               title="Submit Data">
                                                <i class="fas fa-clipboard-list"></i>
                                            </a>
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                            </div>
                            
                            {% if indicator.values.count > 0 %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-check-circle mr-1"></i>Active
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                    <i class="fas fa-clock mr-1"></i>Pending
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="col-span-full text-center py-12">
                    <i class="fas fa-chart-bar text-6xl text-undp-text-light mb-4"></i>
                    <h3 class="text-xl font-semibold text-undp-text mb-2">No Indicators Found</h3>
                    <p class="text-undp-text-light mb-6">No indicators match your current filters.</p>
                    {% if user.profile.is_admin %}
                        <a href="{% url 'dashboard:indicator_create' %}" class="btn-primary">
                            <i class="fas fa-plus mr-2"></i>Create First Indicator
                        </a>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <h3 class="dashboard-card-title">Total Indicators</h3>
                <i class="fas fa-chart-bar dashboard-card-icon"></i>
            </div>
            <div class="dashboard-card-value">{{ indicators.count }}</div>
            <p class="dashboard-card-subtitle">Active indicators</p>
        </div>

        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <h3 class="dashboard-card-title">Output Indicators</h3>
                <i class="fas fa-box dashboard-card-icon"></i>
            </div>
            <div class="dashboard-card-value">
                {% with output_count=0 %}
                    {% for indicator in indicators %}
                        {% if indicator.indicator_type == 'output' %}
                            {% with output_count=output_count|add:1 %}{% endwith %}
                        {% endif %}
                    {% endfor %}
                    {{ output_count }}
                {% endwith %}
            </div>
            <p class="dashboard-card-subtitle">Output type</p>
        </div>

        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <h3 class="dashboard-card-title">Outcome Indicators</h3>
                <i class="fas fa-bullseye dashboard-card-icon"></i>
            </div>
            <div class="dashboard-card-value">
                {% with outcome_count=0 %}
                    {% for indicator in indicators %}
                        {% if indicator.indicator_type == 'outcome' %}
                            {% with outcome_count=outcome_count|add:1 %}{% endwith %}
                        {% endif %}
                    {% endfor %}
                    {{ outcome_count }}
                {% endwith %}
            </div>
            <p class="dashboard-card-subtitle">Outcome type</p>
        </div>

        <div class="dashboard-card">
            <div class="dashboard-card-header">
                <h3 class="dashboard-card-title">With Data</h3>
                <i class="fas fa-database dashboard-card-icon"></i>
            </div>
            <div class="dashboard-card-value">
                {% with data_count=0 %}
                    {% for indicator in indicators %}
                        {% if indicator.values.count > 0 %}
                            {% with data_count=data_count|add:1 %}{% endwith %}
                        {% endif %}
                    {% endfor %}
                    {{ data_count }}
                {% endwith %}
            </div>
            <p class="dashboard-card-subtitle">Have submitted data</p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.btn-secondary.active {
    background-color: #1e40af;
    color: white;
    border-color: #1e40af;
}

.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // View switching functionality
    const tableView = document.getElementById('table-view');
    const cardView = document.getElementById('card-view');
    const tableContainer = document.getElementById('table-container');
    const cardContainer = document.getElementById('card-container');
    
    if (tableView && cardView) {
        tableView.addEventListener('click', function() {
            tableView.classList.add('active');
            cardView.classList.remove('active');
            tableContainer.classList.remove('hidden');
            cardContainer.classList.add('hidden');
        });
        
        cardView.addEventListener('click', function() {
            cardView.classList.add('active');
            tableView.classList.remove('active');
            cardContainer.classList.remove('hidden');
            tableContainer.classList.add('hidden');
        });
    }
});
</script>
{% endblock %}
