{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <div class="space-y-6">
        <!-- Page Header -->
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-undp-text">{{ title }}</h1>
                <p class="text-undp-text-light mt-2">
                    {% if cluster %}
                        Update cluster information
                    {% else %}
                        Create a new thematic cluster
                    {% endif %}
                </p>
            </div>
            
            <a href="{% url 'dashboard:cluster_list' %}" class="btn-secondary">
                <i class="fas fa-arrow-left mr-2"></i>Back to Clusters
            </a>
        </div>

        <!-- Cluster Form -->
        <div class="card">
            <form method="post" class="space-y-6">
                {% csrf_token %}
                
                <!-- Basic Information -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-undp-text border-b border-undp-gray-dark pb-2">
                        Basic Information
                    </h3>
                    
                    <div>
                        <label class="form-label">Cluster Name *</label>
                        {{ form.name }}
                        {% if form.name.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.name.errors.0 }}</div>
                        {% endif %}
                        <div class="text-xs text-undp-text-light mt-1">
                            Enter a descriptive name for this cluster (e.g., "Health", "Education", "Environment")
                        </div>
                    </div>
                    
                    <div>
                        <label class="form-label">Cluster Code *</label>
                        {{ form.code }}
                        {% if form.code.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.code.errors.0 }}</div>
                        {% endif %}
                        <div class="text-xs text-undp-text-light mt-1">
                            Short code for this cluster (e.g., "HLTH", "EDUC", "ENV") - must be unique
                        </div>
                    </div>
                    
                    <div>
                        <label class="form-label">Description</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div class="text-red-500 text-sm mt-1">{{ form.description.errors.0 }}</div>
                        {% endif %}
                        <div class="text-xs text-undp-text-light mt-1">
                            Optional description of what this cluster represents
                        </div>
                    </div>
                </div>

                <!-- Status -->
                <div class="space-y-4">
                    <h3 class="text-lg font-semibold text-undp-text border-b border-undp-gray-dark pb-2">
                        Status
                    </h3>
                    
                    <div class="flex items-center">
                        {{ form.is_active }}
                        <label for="{{ form.is_active.id_for_label }}" class="ml-2 text-sm text-undp-text">
                            Active cluster
                        </label>
                    </div>
                    <div class="text-xs text-undp-text-light">
                        Active clusters can be used for new projects. Inactive clusters are hidden from project creation.
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end space-x-4 pt-6 border-t border-undp-gray-dark">
                    <a href="{% url 'dashboard:cluster_list' %}" class="btn-secondary">
                        Cancel
                    </a>
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save mr-2"></i>
                        {% if cluster %}Update Cluster{% else %}Create Cluster{% endif %}
                    </button>
                </div>
            </form>
        </div>

        <!-- Help Section -->
        <div class="card bg-blue-50 border-blue-200">
            <div class="flex items-start">
                <i class="fas fa-info-circle text-blue-600 text-xl mr-3 mt-1"></i>
                <div>
                    <h4 class="font-semibold text-blue-800 mb-2">About Clusters</h4>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>• Clusters are thematic groupings for organizing related projects</li>
                        <li>• Examples: Health, Education, Environment, Agriculture, etc.</li>
                        <li>• Each project must be assigned to exactly one cluster</li>
                        <li>• Cluster codes should be unique and memorable</li>
                        <li>• Inactive clusters cannot be used for new projects</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Associated Projects (if editing) -->
        {% if cluster and cluster.projects.exists %}
            <div class="card">
                <h3 class="text-lg font-semibold text-undp-text mb-4">Associated Projects</h3>
                
                <div class="space-y-3">
                    {% for project in cluster.projects.all %}
                        <div class="flex items-center justify-between p-3 bg-undp-gray rounded-lg">
                            <div>
                                <div class="font-medium text-undp-text">{{ project.name }}</div>
                                <div class="text-sm text-undp-text-light">{{ project.code }} • {{ project.get_status_display }}</div>
                            </div>
                            <div>
                                <a href="{% url 'dashboard:project_detail' project.id %}" 
                                   class="text-sm text-undp-blue hover:text-undp-blue-dark">
                                    View Project
                                </a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-generate code from name
    const nameField = document.querySelector('input[name="name"]');
    const codeField = document.querySelector('input[name="code"]');
    
    if (nameField && codeField && !codeField.value) {
        nameField.addEventListener('input', function() {
            if (!codeField.value) {
                const code = this.value
                    .toUpperCase()
                    .replace(/[^A-Z\s]/g, '')
                    .split(' ')
                    .map(word => word.substring(0, 4))
                    .join('')
                    .substring(0, 8);
                codeField.value = code;
            }
        });
    }
    
    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
        const name = document.querySelector('input[name="name"]').value.trim();
        const code = document.querySelector('input[name="code"]').value.trim();
        
        if (!name || !code) {
            e.preventDefault();
            alert('Please fill in all required fields.');
            return false;
        }
        
        if (code.length < 2) {
            e.preventDefault();
            alert('Cluster code must be at least 2 characters long.');
            return false;
        }
    });
});
</script>
{% endblock %}
