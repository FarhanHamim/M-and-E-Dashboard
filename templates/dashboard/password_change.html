{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="max-w-lg mx-auto">
    <div class="space-y-6">
        <!-- Page Header -->
        <div class="text-center">
            <h1 class="text-3xl font-bold text-undp-text">{{ title }}</h1>
            <p class="text-undp-text-light mt-2">Update your account password</p>
        </div>

        <!-- Password Change Form -->
        <div class="card">
            <form method="post" class="space-y-6">
                {% csrf_token %}
                
                <!-- Current Password -->
                <div>
                    <label class="form-label">Current Password</label>
                    {{ form.old_password }}
                    {% if form.old_password.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.old_password.errors.0 }}</div>
                    {% endif %}
                </div>

                <!-- New Password -->
                <div>
                    <label class="form-label">New Password</label>
                    {{ form.new_password1 }}
                    {% if form.new_password1.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.new_password1.errors.0 }}</div>
                    {% endif %}
                    
                    <!-- Password Requirements -->
                    <div class="mt-2 text-xs text-undp-text-light">
                        <p class="font-medium mb-1">Password requirements:</p>
                        <ul class="space-y-1">
                            <li id="length-req" class="flex items-center">
                                <i class="fas fa-circle text-gray-400 text-xs mr-2"></i>
                                At least 8 characters long
                            </li>
                            <li id="uppercase-req" class="flex items-center">
                                <i class="fas fa-circle text-gray-400 text-xs mr-2"></i>
                                Contains uppercase letter
                            </li>
                            <li id="lowercase-req" class="flex items-center">
                                <i class="fas fa-circle text-gray-400 text-xs mr-2"></i>
                                Contains lowercase letter
                            </li>
                            <li id="number-req" class="flex items-center">
                                <i class="fas fa-circle text-gray-400 text-xs mr-2"></i>
                                Contains number
                            </li>
                            <li id="special-req" class="flex items-center">
                                <i class="fas fa-circle text-gray-400 text-xs mr-2"></i>
                                Contains special character
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Confirm New Password -->
                <div>
                    <label class="form-label">Confirm New Password</label>
                    {{ form.new_password2 }}
                    {% if form.new_password2.errors %}
                        <div class="text-red-500 text-sm mt-1">{{ form.new_password2.errors.0 }}</div>
                    {% endif %}
                    
                    <!-- Password Match Indicator -->
                    <div id="password-match" class="mt-2 text-sm hidden">
                        <i class="fas fa-check-circle text-green-500 mr-1"></i>
                        <span class="text-green-600">Passwords match</span>
                    </div>
                    <div id="password-mismatch" class="mt-2 text-sm hidden">
                        <i class="fas fa-times-circle text-red-500 mr-1"></i>
                        <span class="text-red-600">Passwords do not match</span>
                    </div>
                </div>

                <!-- Password Strength Indicator -->
                <div class="space-y-2">
                    <label class="text-sm font-medium text-undp-text">Password Strength</label>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div id="strength-bar" class="h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div id="strength-text" class="text-sm text-gray-500">Enter a password to see strength</div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-end space-x-4 pt-6 border-t border-undp-gray-dark">
                    <a href="{% url 'dashboard:profile_view' %}" class="btn-secondary">
                        Cancel
                    </a>
                    <button type="submit" class="btn-primary" id="submit-btn" disabled>
                        <i class="fas fa-save mr-2"></i>Update Password
                    </button>
                </div>
            </form>
        </div>

        <!-- Security Tips -->
        <div class="card bg-blue-50 border-blue-200">
            <div class="flex items-start">
                <i class="fas fa-shield-alt text-blue-600 text-xl mr-3 mt-1"></i>
                <div>
                    <h4 class="font-semibold text-blue-800 mb-2">Password Security Tips</h4>
                    <ul class="text-sm text-blue-700 space-y-1">
                        <li>• Use a unique password that you don't use elsewhere</li>
                        <li>• Include a mix of letters, numbers, and special characters</li>
                        <li>• Avoid using personal information in your password</li>
                        <li>• Consider using a password manager to generate secure passwords</li>
                        <li>• Change your password regularly for better security</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const oldPasswordField = document.querySelector('input[name="old_password"]');
    const newPasswordField = document.querySelector('input[name="new_password1"]');
    const confirmPasswordField = document.querySelector('input[name="new_password2"]');
    const submitBtn = document.getElementById('submit-btn');
    
    // Password strength checker
    if (newPasswordField) {
        newPasswordField.addEventListener('input', function() {
            const password = this.value;
            updatePasswordRequirements(password);
            updatePasswordStrength(password);
            checkPasswordMatch();
        });
    }
    
    // Password confirmation checker
    if (confirmPasswordField) {
        confirmPasswordField.addEventListener('input', function() {
            checkPasswordMatch();
        });
    }
    
    // Form validation
    function validateForm() {
        const oldPassword = oldPasswordField.value.trim();
        const newPassword = newPasswordField.value.trim();
        const confirmPassword = confirmPasswordField.value.trim();
        
        if (oldPassword && newPassword && confirmPassword && newPassword === confirmPassword) {
            submitBtn.disabled = false;
        } else {
            submitBtn.disabled = true;
        }
    }
    
    // Add event listeners for form validation
    [oldPasswordField, newPasswordField, confirmPasswordField].forEach(field => {
        if (field) {
            field.addEventListener('input', validateForm);
        }
    });
});

function updatePasswordRequirements(password) {
    const requirements = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[^a-zA-Z0-9]/.test(password)
    };
    
    // Update requirement indicators
    Object.keys(requirements).forEach(req => {
        const element = document.getElementById(`${req}-req`);
        const icon = element.querySelector('i');
        
        if (requirements[req]) {
            icon.className = 'fas fa-check-circle text-green-500 text-xs mr-2';
            element.classList.add('text-green-600');
            element.classList.remove('text-gray-600');
        } else {
            icon.className = 'fas fa-circle text-gray-400 text-xs mr-2';
            element.classList.add('text-gray-600');
            element.classList.remove('text-green-600');
        }
    });
}

function updatePasswordStrength(password) {
    let strength = 0;
    const requirements = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[^a-zA-Z0-9]/.test(password)
    };
    
    // Calculate strength based on requirements met
    Object.values(requirements).forEach(met => {
        if (met) strength++;
    });
    
    const strengthBar = document.getElementById('strength-bar');
    const strengthText = document.getElementById('strength-text');
    
    const strengthLevels = [
        { width: 0, color: 'bg-gray-400', text: 'Very Weak', textColor: 'text-gray-500' },
        { width: 20, color: 'bg-red-500', text: 'Weak', textColor: 'text-red-500' },
        { width: 40, color: 'bg-orange-500', text: 'Fair', textColor: 'text-orange-500' },
        { width: 60, color: 'bg-yellow-500', text: 'Good', textColor: 'text-yellow-500' },
        { width: 80, color: 'bg-blue-500', text: 'Strong', textColor: 'text-blue-500' },
        { width: 100, color: 'bg-green-500', text: 'Very Strong', textColor: 'text-green-500' }
    ];
    
    const level = strengthLevels[strength];
    
    strengthBar.style.width = `${level.width}%`;
    strengthBar.className = `h-2 rounded-full transition-all duration-300 ${level.color}`;
    strengthText.textContent = level.text;
    strengthText.className = `text-sm ${level.textColor}`;
}

function checkPasswordMatch() {
    const newPassword = document.querySelector('input[name="new_password1"]').value;
    const confirmPassword = document.querySelector('input[name="new_password2"]').value;
    
    const matchDiv = document.getElementById('password-match');
    const mismatchDiv = document.getElementById('password-mismatch');
    
    if (confirmPassword.length === 0) {
        matchDiv.classList.add('hidden');
        mismatchDiv.classList.add('hidden');
        return;
    }
    
    if (newPassword === confirmPassword) {
        matchDiv.classList.remove('hidden');
        mismatchDiv.classList.add('hidden');
    } else {
        matchDiv.classList.add('hidden');
        mismatchDiv.classList.remove('hidden');
    }
}
</script>
{% endblock %}
